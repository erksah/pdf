<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>All-in-One PDF Tool</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.10.111/pdf.min.js"></script>
<style>
  body { font-family: Arial, sans-serif; background: #f4f4f4; margin: 0; padding: 0; }
  header { background: #007bff; color: white; padding: 15px; text-align: center; font-size: 20px; }
  #toolbar { padding: 10px; background: white; display: flex; gap: 10px; align-items: center; justify-content: center; }
  button { padding: 8px 14px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 5px; }
  button:hover { background: #0056b3; }
  #pages { display: flex; flex-wrap: wrap; padding: 10px; gap: 10px; background: #fafafa; }
  .page-thumb { border: 2px solid transparent; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); padding: 5px; border-radius: 5px; }
  .page-thumb img { display: block; max-width: 150px; cursor: move; }
  .delete-btn { background: red; color: white; border: none; font-size: 12px; padding: 3px 5px; cursor: pointer; margin-top: 5px; border-radius: 3px; }
  .delete-btn:hover { background: darkred; }
</style>
</head>
<body>

<header>ðŸ“„ PDF All-in-One Editor</header>

<div id="toolbar">
  <input type="file" id="fileInput" multiple accept="application/pdf,image/*">
  <button onclick="exportPDF()">ðŸ’¾ Export PDF</button>
</div>

<div id="pages"></div>

<script>
let allPages = []; // {pdfDoc, pageIndex} or {imageData}

document.getElementById("fileInput").addEventListener("change", async function() {
  for (let file of this.files) {
    if (file.type === "application/pdf") {
      await loadPDF(file);
    } else if (file.type.startsWith("image/")) {
      await loadImage(file);
    }
  }
  renderPages();
  this.value = ""; // reset so same file can be re-added
});

async function loadPDF(file) {
  const arrayBuffer = await file.arrayBuffer();
  const pdfjs = window['pdfjs-dist/build/pdf'];
  pdfjs.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.10.111/pdf.worker.min.js";
  const pdf = await pdfjs.getDocument({ data: arrayBuffer }).promise;
  for (let i = 0; i < pdf.numPages; i++) {
    const page = await pdf.getPage(i + 1);
    const viewport = page.getViewport({ scale: 0.5 });
    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d");
    canvas.height = viewport.height;
    canvas.width = viewport.width;
    await page.render({ canvasContext: ctx, viewport }).promise;
    const imgData = canvas.toDataURL("image/jpeg", 0.8);
    allPages.push({ type: "pdf", data: arrayBuffer, pageNum: i });
    allPages[allPages.length - 1].preview = imgData;
  }
}

async function loadImage(file) {
  const imgData = await readFileAsDataURL(file);
  allPages.push({ type: "image", preview: imgData, fileData: imgData });
}

function renderPages() {
  const container = document.getElementById("pages");
  container.innerHTML = "";
  allPages.forEach((p, idx) => {
    const div = document.createElement("div");
    div.className = "page-thumb";
    div.draggable = true;
    div.ondragstart = e => e.dataTransfer.setData("text/plain", idx);
    div.ondragover = e => e.preventDefault();
    div.ondrop = e => {
      e.preventDefault();
      const from = e.dataTransfer.getData("text/plain");
      const to = idx;
      allPages.splice(to, 0, allPages.splice(from, 1)[0]);
      renderPages();
    };
    const img = document.createElement("img");
    img.src = p.preview;
    const delBtn = document.createElement("button");
    delBtn.className = "delete-btn";
    delBtn.textContent = "ðŸ—‘ Delete";
    delBtn.onclick = () => { allPages.splice(idx, 1); renderPages(); };
    div.appendChild(img);
    div.appendChild(delBtn);
    container.appendChild(div);
  });
}

async function exportPDF() {
  const { PDFDocument } = PDFLib;
  const outPdf = await PDFDocument.create();
  for (let p of allPages) {
    if (p.type === "pdf") {
      const srcPdf = await PDFDocument.load(p.data);
      const [copiedPage] = await outPdf.copyPages(srcPdf, [p.pageNum]);
      outPdf.addPage(copiedPage);
    } else if (p.type === "image") {
      const jpgImage = await outPdf.embedJpg(p.fileData);
      const page = outPdf.addPage([jpgImage.width, jpgImage.height]);
      page.drawImage(jpgImage, { x: 0, y: 0, width: jpgImage.width, height: jpgImage.height });
    }
  }
  const pdfBytes = await outPdf.save();
  downloadBlob(pdfBytes, "output.pdf");
}

function readFileAsDataURL(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

function downloadBlob(bytes, filename) {
  const blob = new Blob([bytes], { type: "application/pdf" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = filename;
  link.click();
}
</script>

</body>
</html>
