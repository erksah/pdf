<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ðŸ“„ PDF Multi-Tool with Click Preview</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
<style>
  body { font-family: Arial, sans-serif; background: #f0f0f0; padding: 20px; }
  h1 { color: #333; }
  .tool-box { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
  input, button { margin: 10px 5px; padding: 8px; border-radius: 5px; border: none; }
  button { background: #007bff; color: white; cursor: pointer; }
  button:hover { background: #0056b3; }
  button:disabled { background: #aaa; cursor: not-allowed; }
  #pageList { display: flex; flex-wrap: wrap; margin-top: 10px; max-height: 300px; overflow-y: auto; }
  .page-thumb { background: #fff; padding: 5px; margin: 5px; border-radius: 5px; cursor: move; position: relative; width: 100px; box-shadow: 0 0 5px rgba(0,0,0,0.2); display: flex; flex-direction: column; align-items: center; transition: transform 0.2s; }
  .page-thumb.dragging { opacity: 0.5; border: 2px dashed #007bff; }
  .page-thumb img, .page-thumb canvas { width: 100%; border-radius: 5px; display: block; }
  .page-number { margin-top: 3px; font-weight: bold; color: #333; font-size: 12px; }
  .delete-btn { position: absolute; top: 2px; right: 2px; background: red; color: white; border: none; border-radius: 50%; width: 18px; height: 18px; cursor: pointer; line-height: 16px; font-weight: bold; }
  #previewContainer { margin-top: 15px; text-align: center; }
  #previewContainer img, #previewContainer canvas { max-width: 80%; max-height: 400px; border: 2px solid #007bff; border-radius: 8px; }
</style>
</head>
<body>

<h1>ðŸ“„ PDF Multi-Tool with Click Preview</h1>
<div class="tool-box">
  <input type="file" id="fileInput" multiple accept="application/pdf,image/*">
  <button id="exportBtn" onclick="exportPDF()" disabled>ðŸ’¾ Export Final PDF</button>
  <div id="pageList"></div>
  <div id="previewContainer"></div>
</div>

<script>
pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js";

let workspacePages = [];
const exportBtn = document.getElementById("exportBtn");
const previewContainer = document.getElementById("previewContainer");

document.getElementById("fileInput").addEventListener("change", async (e) => {
  const files = e.target.files;
  for (const file of files) {
    if (file.type.startsWith("image/")) {
      await addImagePage(file);
    } else if (file.type === "application/pdf") {
      await addPDFPages(file);
    }
  }
  renderPageList();
  exportBtn.disabled = workspacePages.length === 0;
});

// Add image as a page
async function addImagePage(file) {
  const dataUrl = await new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
  workspacePages.push({ type: "image", data: dataUrl });
}

// Add all PDF pages
async function addPDFPages(file) {
  const arrayBuffer = await file.arrayBuffer();
  const pdfDoc = await PDFLib.PDFDocument.load(arrayBuffer);
  const pageIndices = pdfDoc.getPageIndices();
  for (const index of pageIndices) {
    workspacePages.push({ type: "pdf", source: pdfDoc, index, buffer: arrayBuffer });
  }
}

// Render all pages
function renderPageList() {
  const container = document.getElementById("pageList");
  container.innerHTML = "";
  workspacePages.forEach((page, i) => {
    const div = document.createElement("div");
    div.className = "page-thumb";
    div.draggable = true;

    // Drag & drop handlers
    div.ondragstart = e => {
      e.dataTransfer.setData("text/plain", i);
      div.classList.add("dragging");
    };
    div.ondragend = e => div.classList.remove("dragging");
    div.ondragover = e => e.preventDefault();
    div.ondrop = e => {
      e.preventDefault();
      const from = parseInt(e.dataTransfer.getData("text/plain"));
      const to = i;
      const moved = workspacePages.splice(from, 1)[0];
      workspacePages.splice(to, 0, moved);
      renderPageList();
    };

    // Delete button
    const delBtn = document.createElement("button");
    delBtn.className = "delete-btn";
    delBtn.textContent = "Ã—";
    delBtn.onclick = () => {
      workspacePages.splice(i, 1);
      renderPageList();
      exportBtn.disabled = workspacePages.length === 0;
      previewContainer.innerHTML = ""; // hide preview if deleted
    };
    div.appendChild(delBtn);

    // Thumbnail image or PDF canvas
    if (page.type === "image") {
      const img = document.createElement("img");
      img.src = page.data;
      div.appendChild(img);
      div.onclick = () => showPreview(page);
    } else if (page.type === "pdf") {
      const canvas = document.createElement("canvas");
      div.appendChild(canvas);
      requestAnimationFrame(() => renderPDFPageThumbnail(page.buffer, page.index, canvas));
      div.onclick = () => showPreview(page);
    }

    // Page number
    const numberLabel = document.createElement("div");
    numberLabel.className = "page-number";
    numberLabel.textContent = `Page ${i + 1}`;
    div.appendChild(numberLabel);

    container.appendChild(div);
  });
}

// Show single preview
function showPreview(page) {
  previewContainer.innerHTML = "";
  if (page.type === "image") {
    const img = document.createElement("img");
    img.src = page.data;
    previewContainer.appendChild(img);
  } else if (page.type === "pdf") {
    const canvas = document.createElement("canvas");
    previewContainer.appendChild(canvas);
    requestAnimationFrame(() => renderPDFPagePreview(page.buffer, page.index, canvas));
  }
}

// Render PDF page as thumbnail
async function renderPDFPageThumbnail(buffer, pageIndex, canvas) {
  const pdf = await pdfjsLib.getDocument({ data: buffer }).promise;
  const page = await pdf.getPage(pageIndex + 1);
  const scale = 100 / page.getViewport({ scale: 1 }).width; // fit thumbnail width
  const viewport = page.getViewport({ scale });
  canvas.width = viewport.width;
  canvas.height = viewport.height;
  const context = canvas.getContext('2d');
  await page.render({ canvasContext: context, viewport }).promise;
}

// Render PDF page for preview
async function renderPDFPagePreview(buffer, pageIndex, canvas) {
  const pdf = await pdfjsLib.getDocument({ data: buffer }).promise;
  const page = await pdf.getPage(pageIndex + 1);
  const scale = 1.5; // larger preview
  const viewport = page.getViewport({ scale });
  canvas.width = viewport.width;
  canvas.height = viewport.height;
  const context = canvas.getContext('2d');
  await page.render({ canvasContext: context, viewport }).promise;
}

// Export final PDF
async function exportPDF() {
  if(workspacePages.length === 0) return;

  const pdfDoc = await PDFLib.PDFDocument.create();
  for (const page of workspacePages) {
    if (page.type === "pdf") {
      const [copied] = await pdfDoc.copyPages(page.source, [page.index]);
      pdfDoc.addPage(copied);
    } else if (page.type === "image") {
      const jpgImage = await pdfDoc.embedJpg(page.data);
      const pageObj = pdfDoc.addPage();
      const { width, height } = pageObj.getSize();
      pageObj.drawImage(jpgImage, { x: 0, y: 0, width, height });
    }
  }
  const bytes = await pdfDoc.save();
  downloadBlob(bytes, "final_output.pdf");
}

function downloadBlob(bytes, filename) {
  const blob = new Blob([bytes], { type: "application/pdf" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = filename;
  link.click();
}
</script>
</body>
</html>
